name: Update GeoIP Database

on:
  schedule:
    - cron: '0 2 * * 3' # æ¯å‘¨ä¸‰è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # è¯»å†™æƒé™
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # 1. é…ç½® Cloudflare WARP (è§£å†³ 451/403 é”™è¯¯)
    - name: Set up Cloudflare WARP
      uses: fscarmen/warp-on-actions@v1.3
      with:
        stack: ipv4

    # 2. å®‰è£…ä¸‹è½½å·¥å…·
    - name: Install geoipupdate
      run: |
        wget https://github.com/maxmind/geoipupdate/releases/download/v6.0.0/geoipupdate_6.0.0_linux_amd64.tar.gz
        tar -xzvf geoipupdate_6.0.0_linux_amd64.tar.gz
        sudo cp geoipupdate_6.0.0_linux_amd64/geoipupdate /usr/local/bin/
        
    # 3. ä¸‹è½½ä¸‰ä¸ªåº“ (City, ASN, Country)
    - name: Run geoipupdate
      env:
        GEOIPUPDATE_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
        GEOIPUPDATE_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        GEOIPUPDATE_EDITION_IDS: GeoLite2-City GeoLite2-ASN GeoLite2-Country
      run: |
        echo "AccountID $GEOIPUPDATE_ACCOUNT_ID" > GeoIP.conf
        echo "LicenseKey $GEOIPUPDATE_LICENSE_KEY" >> GeoIP.conf
        echo "EditionIDs $GEOIPUPDATE_EDITION_IDS" >> GeoIP.conf
        # å¢åŠ é‡è¯•æœºåˆ¶
        for i in {1..3}; do geoipupdate -d . -f GeoIP.conf -v && break || sleep 10; done

    # 4. æš´åŠ›æäº¤ (Force Push) - å½»åº•è§£å†³å†²çª
    - name: Commit and Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add *.mmdb
        
        # æ£€æŸ¥æœ‰æ²¡æœ‰å˜åŠ¨
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes detected, skipping push"
          exit 0
        fi

        # æäº¤
        git commit -m "Auto-update GeoIP databases"
        
        # ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šä½¿ç”¨ -f å¼ºåˆ¶æ¨é€
        # æ„æ€æ˜¯ï¼šåˆ«ç®¡è¿œç¨‹æœ‰ä»€ä¹ˆï¼Œä»¥æˆ‘ç°åœ¨çš„ç‰ˆæœ¬ä¸ºå‡†ï¼
        git push -f origin main
