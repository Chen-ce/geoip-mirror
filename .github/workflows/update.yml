name: Update GeoIP Database

on:
  schedule:
    - cron: '0 2 * * 3' # æ¯å‘¨ä¸‰ UTC 02:00 è¿è¡Œ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # è¯»å†™æƒé™ (æäº¤ä»£ç  + å‘ç‰ˆéƒ½éœ€è¦)
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install geoipupdate
      run: |
        wget https://github.com/maxmind/geoipupdate/releases/download/v6.0.0/geoipupdate_6.0.0_linux_amd64.tar.gz
        tar -xzvf geoipupdate_6.0.0_linux_amd64.tar.gz
        sudo cp geoipupdate_6.0.0_linux_amd64/geoipupdate /usr/local/bin/
        
    - name: Run geoipupdate
      env:
        GEOIPUPDATE_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
        GEOIPUPDATE_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        GEOIPUPDATE_EDITION_IDS: GeoLite2-City GeoLite2-ASN GeoLite2-Country
      run: |
        echo "AccountID $GEOIPUPDATE_ACCOUNT_ID" > GeoIP.conf
        echo "LicenseKey $GEOIPUPDATE_LICENSE_KEY" >> GeoIP.conf
        echo "EditionIDs $GEOIPUPDATE_EDITION_IDS" >> GeoIP.conf
        geoipupdate -d . -f GeoIP.conf -v

    - name: Commit and Push to Repository
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add *.mmdb
        
        # æ£€æŸ¥æœ‰æ²¡æœ‰å˜åŠ¨ï¼Œæ²¡å˜åŠ¨å°±ä¸æäº¤ä»£ç ï¼Œä½†å¯èƒ½ä»éœ€å‘ Release (è§†æƒ…å†µè€Œå®š)
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes detected in repo."
        else
          TAG_DATE=$(date +'%Y-%m-%d')
          git commit -m "Update databases: $TAG_DATE"
          git pull --rebase origin main
          git push
        fi

    # ğŸ”¥ æ ¸å¿ƒæ–°å¢ï¼šå‘å¸ƒ Release
    - name: Create GitHub Release
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # 1. ç”Ÿæˆæ—¥æœŸæ ‡ç­¾ï¼Œä¾‹å¦‚ 2025-09-12 (UTCæ—¶é—´)
        TAG_NAME=$(date +'%Y-%m-%d')
        
        # 2. å¦‚æœå½“å¤©å·²ç»å‘è¿‡ç‰ˆï¼ˆæ¯”å¦‚ä½ æ‰‹åŠ¨è·‘äº†ä¸¤æ¬¡ï¼‰ï¼Œå…ˆåˆ é™¤æ—§çš„ï¼Œé˜²æ­¢æŠ¥é”™
        # "|| true" çš„æ„æ€æ˜¯å³ä½¿åˆ é™¤å¤±è´¥ï¼ˆæ¯”å¦‚ä¸å­˜åœ¨ï¼‰ä¹Ÿä¸æŠ¥é”™ï¼Œç»§ç»­å¾€ä¸‹èµ°
        gh release delete "$TAG_NAME" --cleanup-tag -y || true
        
        # 3. åˆ›å»ºæ–° Release å¹¶ä¸Šä¼  3 ä¸ª .mmdb æ–‡ä»¶
        # --title: æ ‡é¢˜
        # --notes: è¯´æ˜æ–‡æ¡ˆ
        gh release create "$TAG_NAME" \
          GeoLite2-City.mmdb \
          GeoLite2-ASN.mmdb \
          GeoLite2-Country.mmdb \
          --title "$TAG_NAME" \
          --notes "MaxMind GeoLite2 databases updated on $TAG_NAME (UTC)."
