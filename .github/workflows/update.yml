name: Update GeoIP Database

on:
  schedule:
    - cron: '0 2 * * 3' # 每周三运行
  workflow_dispatch: # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # 确保有写权限
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Cloudflare WARP
      uses: fscarmen/warp-on-actions@v1.3
      with:
        stack: ipv4

    # 2. 安装下载工具
    - name: Install geoipupdate
      run: |
        wget https://github.com/maxmind/geoipupdate/releases/download/v6.0.0/geoipupdate_6.0.0_linux_amd64.tar.gz
        tar -xzvf geoipupdate_6.0.0_linux_amd64.tar.gz
        sudo cp geoipupdate_6.0.0_linux_amd64/geoipupdate /usr/local/bin/
        
    # 3. 下载三个库 (City, ASN, Country)
    - name: Run geoipupdate
      env:
        GEOIPUPDATE_ACCOUNT_ID: ${{ secrets.MAXMIND_ACCOUNT_ID }}
        GEOIPUPDATE_LICENSE_KEY: ${{ secrets.MAXMIND_LICENSE_KEY }}
        GEOIPUPDATE_EDITION_IDS: GeoLite2-City GeoLite2-ASN GeoLite2-Country
      run: |
        echo "AccountID $GEOIPUPDATE_ACCOUNT_ID" > GeoIP.conf
        echo "LicenseKey $GEOIPUPDATE_LICENSE_KEY" >> GeoIP.conf
        echo "EditionIDs $GEOIPUPDATE_EDITION_IDS" >> GeoIP.conf
        # 增加重试机制
        for i in {1..3}; do geoipupdate -d . -f GeoIP.conf -v && break || sleep 10; done

    # 4. 提交并上传 
    - name: Commit and Push
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add *.mmdb
        
        # 如果没有文件变化，就不提交
        if git diff --quiet && git diff --staged --quiet; then
          echo "No changes detected, skipping push"
          exit 0
        fi

        git commit -m "Auto-update GeoIP databases"
        
        git pull --rebase origin main
        
        git push
